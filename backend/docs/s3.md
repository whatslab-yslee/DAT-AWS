# S3 개발 가이드 (LocalStack)

## 개요

이 문서는 API 서버에서 AWS S3 관련 기능을 로컬 개발 환경에서 테스트하기 위한 LocalStack 활용 방법을 설명합니다. 백엔드 개발자가 S3 기능(파일 업로드/다운로드, presigned URL 발급 등)을 실제 AWS 계정 없이 로컬 환경에서 개발하고 테스트할 수 있도록 LocalStack을 사용합니다.

## LocalStack 소개

LocalStack은 AWS 클라우드 서비스를 로컬 환경에서 에뮬레이션하는 도구입니다. 개발 및 테스트 환경에서 실제 AWS 서비스를 사용하지 않고도 동일한 API와 기능을 사용할 수 있습니다.

### 주요 이점

- **비용 효율성**: 실제 AWS 리소스를 사용하지 않아 비용이 발생하지 않습니다.
- **오프라인 개발**: 인터넷 연결 없이도 개발과 테스트가 가능합니다.
- **개발 속도 향상**: 로컬 환경에서 빠른 반복 개발이 가능합니다.
- **환경 일관성**: 모든 개발자가 동일한 로컬 환경에서 작업할 수 있습니다.

## 프로젝트 설정

### 1. 환경 설정

프로젝트의 `.env` 파일에 다음 설정이 포함되어 있는지 확인하세요:

```
# 환경 설정
ENV=local  # 로컬 개발 환경 (LocalStack 사용)

# S3 관련 설정
S3_BUCKET_NAME="test-bucket"
AWS_REGION="ap-northeast-2"
LOCALSTACK_ENDPOINT="http://localstack:4566"
```

### 2. 서비스 시작

LocalStack을 포함한 모든 서비스를 시작하려면:

```bash
docker compose up
# 또는
make dev
```

LocalStack만 단독으로 시작하려면:

```bash
docker compose up -d localstack
```

## S3 서비스 구현 가이드

프로젝트에는 이미 `app/services/s3_service.py`에 기본적인 S3 서비스 구현이 포함되어 있습니다. 이 서비스는 환경 변수에 따라 자동으로 실제 AWS S3 또는 LocalStack을 사용합니다.

### 주요 기능

1. **Presigned URL 생성**: 파일 업로드를 위한 임시 URL 발급
2. **파일 목록 조회**: S3 버킷 내 파일 목록 조회
3. **다운로드 URL 생성**: 파일 다운로드를 위한 임시 URL 발급

### S3 기능 확장 방법

새로운 S3 기능을 구현하려면 다음과 같이 `S3Service` 클래스에 메서드를 추가하세요:

```python
def upload_file(self, local_file_path: str, object_name: str) -> bool:
    """
    로컬 파일을 S3에 직접 업로드합니다.

    Args:
        local_file_path: 업로드할 로컬 파일 경로
        object_name: S3에서의 객체 이름 (경로 포함)

    Returns:
        bool: 업로드 성공 여부
    """
    try:
        self.s3_client.upload_file(local_file_path, self.bucket_name, object_name)
        return True
    except ClientError as e:
        logger.error(f"Error uploading file to S3: {e}")
        return False
```

## 데이터베이스와 S3 연동 예시

S3 파일 URL을 데이터베이스에 저장하고 관리하는 일반적인 패턴은 다음과 같습니다:

```python
from app.models.file import FileModel
from app.repositories.file_repository import FileRepository
from app.services.s3_service import S3Service

class FileService:
    def __init__(self, file_repository: FileRepository, s3_service: S3Service):
        self.file_repository = file_repository
        self.s3_service = s3_service

    async def upload_and_save(self, file_data: bytes, filename: str, user_id: int) -> FileModel:
        """
        파일을 S3에 업로드하고 DB에 정보를 저장합니다.
        """
        # S3에 업로드할 객체 키 생성
        object_key = f"users/{user_id}/{filename}"

        # 메모리 내 파일을 임시 파일로 저장
        import tempfile
        with tempfile.NamedTemporaryFile(delete=False) as temp_file:
            temp_file.write(file_data)
            temp_file_path = temp_file.name

        # S3에 업로드
        self.s3_service.upload_file(temp_file_path, object_key)

        # 임시 파일 삭제
        import os
        os.unlink(temp_file_path)

        # 데이터베이스에 파일 정보 저장
        file_model = FileModel(
            filename=filename,
            s3_key=object_key,
            user_id=user_id,
            size=len(file_data)
        )
        saved_file = await self.file_repository.create(file_model)

        return saved_file

    async def get_download_url(self, file_id: int) -> str:
        """
        파일 ID로 다운로드 URL을 생성합니다.
        """
        # DB에서 파일 정보 조회
        file = await self.file_repository.get_by_id(file_id)
        if not file:
            raise ValueError("파일을 찾을 수 없습니다.")

        # S3 다운로드 URL 생성
        download_url = self.s3_service.generate_download_url(file.s3_key)

        return download_url
```

## Presigned URL 활용 가이드

### 업로드용 Presigned URL

클라이언트가 S3에 직접 업로드할 수 있도록 presigned URL을 생성합니다:

```python
# 컨트롤러에서의 사용 예시
@router.post("/files/upload-url")
async def create_upload_url(
    filename: str,
    user_id: int = Depends(get_current_user_id),
    s3_service: S3Service = Depends(get_s3_service)
):
    # S3 객체 키 생성 (사용자별 폴더 구분)
    object_key = f"users/{user_id}/{filename}"

    # presigned URL 생성
    presigned_url = s3_service.generate_presigned_url(object_key)

    # URL과 함께 필요한 메타데이터 반환
    return {
        "presigned_url": presigned_url,
        "object_key": object_key,
        "expires_in": 3600  # 1시간
    }
```

### 다운로드용 Presigned URL

저장된 파일을 다운로드할 수 있는 임시 URL을 생성합니다:

```python
# 컨트롤러에서의 사용 예시
@router.get("/files/{file_id}/download-url")
async def get_file_download_url(
    file_id: int,
    file_service: FileService = Depends(get_file_service)
):
    try:
        download_url = await file_service.get_download_url(file_id)
        return {"download_url": download_url}
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
```

## LocalStack 문제 해결

### 1. 버킷 생성 오류

**문제**: S3 버킷이 자동으로 생성되지 않거나 오류가 발생하는 경우

**해결책**:
수동으로 버킷을 생성합니다:

```bash
docker exec -it local-s3-stack aws --endpoint-url=http://localhost:4566 s3 mb s3://test-bucket
```

### 2. LocalStack 연결 문제

**문제**: "Connection refused" 오류 발생

**해결책**:

1. LocalStack 컨테이너가 실행 중인지 확인
2. 컨테이너 로그 확인
   ```bash
   docker logs local-s3-stack
   ```
3. LocalStack 재시작
   ```bash
   docker compose restart localstack
   ```

### 3. Presigned URL 호스트명 문제

**문제**: 로컬 환경에서 생성된 presigned URL에 `localstack` 호스트명이 포함되어 브라우저에서 접근할 수 없음

**해결책**:
S3 서비스 클래스에 `endpoint_url_external` 파라미터를 추가하여 외부 접근용 URL을 구성합니다:

```python
def generate_presigned_url(self, object_name: str, expiration: int = 3600) -> Optional[str]:
    try:
        # 로컬 환경인 경우 외부 접근용 엔드포인트 사용
        endpoint_url = None
        if is_local:
            # presigned URL 생성에 사용될 외부 접근용 엔드포인트
            endpoint_url = "http://localhost:4566"

            # boto3 client 생성 (URL 생성용)
            s3_client = boto3.client(
                's3',
                endpoint_url=endpoint_url,
                region_name=self.region_name,
                aws_access_key_id='test',
                aws_secret_access_key='test'
            )
        else:
            s3_client = self.s3_client

        response = s3_client.generate_presigned_url(
            'put_object',
            Params={
                'Bucket': self.bucket_name,
                'Key': object_name,
                'ContentType': 'application/octet-stream'
            },
            ExpiresIn=expiration
        )
        return response
    except ClientError as e:
        logger.error(f"Error generating presigned URL: {e}")
        return None
```

## 프로덕션 환경으로의 전환

개발이 완료되고 프로덕션 환경으로 전환할 때는 다음 사항을 확인하세요:

1. `.env` 파일에서 `ENV=production`으로 설정 (또는 ENV 변수 제거)
2. 실제 S3 버킷 이름으로 `S3_BUCKET_NAME` 설정
3. AWS 자격 증명 설정 (IAM 역할 또는 액세스 키)

변경 없이 동일한 코드가 실제 AWS S3와 함께 작동합니다.

## 참고 리소스

- [LocalStack S3 문서](https://docs.localstack.cloud/user-guide/aws/s3/)
- [Boto3 S3 문서](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html)
- [AWS S3 Presigned URL 문서](https://docs.aws.amazon.com/AmazonS3/latest/userguide/PresignedUrlUploadObject.html)
